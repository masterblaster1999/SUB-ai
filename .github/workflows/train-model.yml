name: Train SUB ai Model

on:
  workflow_dispatch:
    inputs:
      epochs:
        description: 'Number of training epochs'
        required: false
        default: '15'
      batch_size:
        description: 'Batch size for training'
        required: false
        default: '128'
      create_release:
        description: 'Create GitHub release with trained model'
        required: false
        default: 'true'
        type: boolean

jobs:
  train:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create models directory
      run: mkdir -p models
    
    - name: Train the model
      run: |
        echo "Starting SUB ai model training..."
        python train.py
      env:
        EPOCHS: ${{ github.event.inputs.epochs || '15' }}
        BATCH_SIZE: ${{ github.event.inputs.batch_size || '128' }}
    
    - name: Check model files
      run: |
        echo "Generated model files:"
        ls -lh models/
    
    - name: Get timestamp
      id: timestamp
      run: echo "timestamp=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
    
    - name: Upload trained model as artifact
      uses: actions/upload-artifact@v4
      with:
        name: number-detection-model-${{ steps.timestamp.outputs.timestamp }}
        path: |
          models/*.h5
          models/*.png
        retention-days: 90
    
    - name: Create Release
      if: ${{ github.event.inputs.create_release == 'true' }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: number-model-v${{ steps.timestamp.outputs.timestamp }}
        name: "Number Detection Model - ${{ steps.timestamp.outputs.timestamp }}"
        body: |
          ## ðŸ”¢ SUB ai Number Detection Model
          
          **Training Date**: ${{ steps.timestamp.outputs.timestamp }}
          **Dataset**: MNIST (70,000 images)
          **Training Configuration**:
          - Epochs: ${{ github.event.inputs.epochs || '15' }}
          - Batch Size: ${{ github.event.inputs.batch_size || '128' }}
          
          ### Model Performance
          - Expected Accuracy: 98-99%
          - Model Size: ~1.5 MB
          - Input: 28x28 grayscale images
          - Output: Digit classification (0-9)
          
          ### How to Use
          
          1. Download `sub_ai_model_latest.h5`
          2. Place in `models/` directory
          3. Run: `python test_detector.py`
          
          ```python
          from number_detector import NumberDetector
          
          detector = NumberDetector('models/sub_ai_model_latest.h5')
          result = detector.detect('image.png')
          print(result['message'])
          ```
          
          ### Files Included
          - `sub_ai_model_latest.h5` - Trained CNN model
          - `sub_ai_model_training_history.png` - Training visualization
        files: |
          models/sub_ai_model_latest.h5
          models/sub_ai_model_*.h5
          models/sub_ai_model_training_history.png
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
